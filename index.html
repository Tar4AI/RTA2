<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mobile RTA (+ Spectrogram) – Safe Start</title>
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#9ca3af;--text:#e5e7eb}
    html,body{margin:0;height:100%;background:#0a1120;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button{background:#10b981;border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700}
    button.secondary{background:#374151}
    canvas{width:100%;height:320px;background:#0b1220;border-radius:12px}
    .hint{font-size:12px;color:var(--muted)}
  </style>
  <!-- สำคัญ: ให้สคริปต์ defer เสมอ ถ้าอยู่ใน <head> -->
  <script defer>
  (() => {
    // ----- DOM refs (ผูกหลัง DOM โหลด เพราะใช้ defer) -----
    let audioCtx, analyser, micSrc, rafId;
    let dataArray, freqArray;
    let running = false;

    function qs(id){ return document.getElementById(id); }
    function dbfs(v){ return 20*Math.log10(v/255 + 1e-12); }

    function logError(err){
      console.error(err);
      alert('เปิดไมโครโฟนไม่สำเร็จ: ' + (err && (err.message||err.name||err)));
      qs('btnStart').disabled = false;
      qs('btnStop').disabled  = true;
    }

    async function start(){
      try{
        // ป้องกันคลิกซ้ำ
        qs('btnStart').disabled = true;
        qs('btnStop').disabled  = false;

        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          throw new Error('เบราว์เซอร์นี้ไม่รองรับ getUserMedia()');
        }

        // ขอไมค์ (ค่า DSP ใช้ค่าเริ่มก่อน เดี๋ยวค่อยไปผูกกับ checkbox ได้)
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false }
        });

        // iOS/Safari: ต้องสร้าง/ resume ภายใต้ user gesture
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:'interactive'});
        if(audioCtx.state === 'suspended') await audioCtx.resume();

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 4096;
        analyser.smoothingTimeConstant = 0.75;

        micSrc = audioCtx.createMediaStreamSource(stream);
        micSrc.connect(analyser);

        dataArray = new Uint8Array(analyser.fftSize);
        freqArray = new Uint8Array(analyser.frequencyBinCount);

        running = true;
        loop();

      }catch(err){ logError(err); }
    }

    function stop(){
      running = false;
      if(rafId) cancelAnimationFrame(rafId);
      try{ micSrc && micSrc.disconnect(); }catch{}
      try{ analyser && analyser.disconnect(); }catch{}
      if(audioCtx){ audioCtx.close(); }
      qs('btnStart').disabled = false;
      qs('btnStop').disabled  = true;
    }

    // ----- วาด FFT แบบง่ายเพื่อเช็คว่าทำงาน -----
    const fftCanvas = () => qs('fftCanvas').getContext('2d');

    function drawFFT(){
      const ctx = fftCanvas();
      const {width:w,height:h} = ctx.canvas;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = '#0b1220'; ctx.fillRect(0,0,w,h);

      const N = freqArray.length;
      const sampleRate = audioCtx.sampleRate;
      const fpb = sampleRate/(2*N);

      // แกนง่ายๆ
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.strokeRect(40,10,w-50,h-20);
      ctx.fillStyle = 'rgba(255,255,255,0.55)';
      ctx.font = '12px system-ui';
      ['31.5','63','125','250','500','1k','2k','4k','8k','16k'].forEach((t,i)=>{
        // map log x คร่าว ๆ
        const ticks = [31.5,63,125,250,500,1000,2000,4000,8000,16000];
        const f = ticks[i];
        const lx = (Math.log10(f)-Math.log10(20)) / (Math.log10(Math.min(sampleRate/2,20000)) - Math.log10(20));
        const x = 40 + lx * (w-50);
        ctx.fillText(t, x-8, h-4);
        ctx.strokeStyle='rgba(255,255,255,0.05)';
        ctx.beginPath(); ctx.moveTo(x,10); ctx.lineTo(x,h-10); ctx.stroke();
      });

      // เส้น
      ctx.beginPath();
      let started=false;
      for(let i=1;i<N;i++){
        const f = i*fpb; if(f<20) continue; if(f>20000) break;
        const lx = (Math.log10(f)-Math.log10(20)) / (Math.log10(Math.min(audioCtx.sampleRate/2,20000)) - Math.log10(20));
        const x = 40 + lx * (w-50);
        const y = 10 + (1 - Math.min(Math.max((dbfs(freqArray[i])+100)/100,0),1)) * (h-20);
        if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = '#34d399';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function loop(){
      if(!running) return;
      analyser.getByteTimeDomainData(dataArray);
      analyser.getByteFrequencyData(freqArray);
      drawFFT();
      rafId = requestAnimationFrame(loop);
    }

    // ----- bind events หลัง DOM มีแน่นอน (เพราะใช้ defer) -----
    window.addEventListener('DOMContentLoaded', () => {
      // กัน text selection/ touch-callout บน iOS
      document.body.style.webkitUserSelect = 'none';
      document.body.style.userSelect = 'none';
      document.body.style.webkitTouchCallout = 'none';

      const bStart = qs('btnStart');
      const bStop  = qs('btnStop');
      if(!bStart || !bStop){ alert('ไม่พบปุ่ม Start/Stop: ตรวจ id ใน HTML'); return; }

      bStart.addEventListener('click', start, {passive:true});
      bStop.addEventListener('click',  stop,  {passive:true});
    });
  })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 4px 0">Mobile RTA (+ Spectrogram)</h2>
          <div class="hint">ถ้ากดแล้วไม่ขึ้น ให้เช็กสิทธิ์ไมโครโฟนและดู error ใน Console</div>
        </div>
        <div class="row">
          <button id="btnStart">▶️ เริ่มวัด</button>
          <button id="btnStop" class="secondary" disabled>⏸️ หยุด</button>
        </div>
      </div>
    </div>

    <div class="card">
      <b>RTA แบบละเอียด (FFT, Log Frequency)</b>
      <canvas id="fftCanvas" width="1200" height="320"></canvas>
    </div>
  </div>
</body>
</html>
