<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a1120" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Mobile RTA (dB-A only) ‚Äî FFT ‚Ä¢ 1/n Oct ‚Ä¢ Heatmap</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a1120; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --gridH:rgba(255,255,255,.06); --gridV:rgba(255,255,255,.035);
      --frame:rgba(255,255,255,.08); --label:rgba(255,255,255,.55);
      --fft:#34d399; --hold:#a78bfa; --peakline:#60a5fa; --holdline:#facc15; --bar:#34d399;
      --h1:#0b1220; --h2:#3b82f6; --h3:#22c55e; --h4:#facc15; --h5:#ef4444;
    }
    :root{ color-scheme:dark }
    html{ background:#0a1120 }
    body{
      margin:0; height:100%;
      background:radial-gradient(1200px 600px at 70% -10%, #0f1730 10%, var(--bg1) 60%, var(--bg2) 100%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; overscroll-behavior:contain;
    }
    body::before,body::after{content:"";position:fixed;left:0;right:0;z-index:9999;background:#0a1120;pointer-events:none}
    body::before{top:0;height:env(safe-area-inset-top)} body::after{bottom:0;height:env(safe-area-inset-bottom)}
    @supports (padding: env(safe-area-inset-left)){
      html::before,html::after{content:"";position:fixed;top:0;bottom:0;background:#0a1120;z-index:9998;pointer-events:none}
      html::before{left:0;width:env(safe-area-inset-left)} html::after{right:0;width:env(safe-area-inset-right)}
    }
    .wrap{display:flex;flex-direction:column;gap:12px;max-width:920px;margin:0 auto;
      padding-left:calc(12px + env(safe-area-inset-left));
      padding-right:calc(12px + env(safe-area-inset-right));
      padding-top:calc(12px + env(safe-area-inset-top));
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px}
    button,select,input[type=range],input[type=number]{-webkit-tap-highlight-color:transparent}
    button{background:#10b981;border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:#374151} button.ghost{background:#1f2937}
    label{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:320px;background:#0b1220;border-radius:12px;touch-action:none}
    .hint{font-size:12px;color:var(--muted)}
    .badges{display:flex;justify-content:flex-end;gap:6px;margin:4px 0 6px 0}
    .badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);font-size:12px;color:#e5e7eb;white-space:nowrap}
    .plot{position:relative}
    .tip{position:absolute;padding:4px 6px;font-size:12px;color:#e5e7eb;background:rgba(0,0,0,.6);
      border:1px solid rgba(255,255,255,.12);border-radius:8px;transform:translate(-50%,-100%);pointer-events:none;white-space:nowrap;z-index:10}
    /* meters */
    .kv{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .kv div{background:#0e1628;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
    .kv b{display:block;color:#cbd5e1;font-size:12px;margin-bottom:4px}
    .kv span{font-size:20px;font-weight:700}
    .meter-now{box-shadow:0 0 0 1px rgba(16,185,129,.25) inset}
    .meter-now span{font-size:28px;line-height:1.2}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 4px 0">Mobile RTA ‚Äî dB-A</h2>
          <div class="hint">‡πÅ‡∏Å‡∏ô X = Log (20 Hz ‚Üí 20 kHz) ‚Ä¢ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å A-weight ‡πÄ‡∏™‡∏°‡∏≠ (‡∏´‡∏ô‡πà‡∏ß‡∏¢ dB-A)</div>
        </div>
        <div class="row">
          <button id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î</button>
          <button id="btnStop" class="secondary" disabled>‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
          <button id="btnHold" class="ghost" aria-pressed="false">üìå Hold Peak: OFF</button>
          <button id="btnClear" class="secondary">‚ôªÔ∏è Clear Peak</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <label>FFT Size
          <select id="fft">
            <option value="2048">2048</option>
            <option value="4096" selected>4096</option>
            <option value="8192">8192</option>
            <option value="16384">16384</option>
          </select>
        </label>
        <label> Smoothing <input id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.75"></label>
        <label> Averaging <input id="avg" type="checkbox" checked></label>
        <label> Octave
          <select id="octRes">
            <option value="3">1/3</option>
            <option value="6" selected>1/6</option>
          </select>
        </label>
        <label>Cal Offset (dB)
          <input id="cal" type="number" step="0.1" value="0" style="width:80px">
        </label>
        <div class="hint">* dB-A ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏™‡πÄ‡∏Å‡∏•</div>
      </div>
      <div class="row">
        <label>‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏¥‡∏î DSP ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡∏õ‡∏¥‡∏î):</label>
        <div class="row">
          <label>echoCancellation <input id="ec" type="checkbox" checked></label>
          <label>noiseSuppression <input id="ns" type="checkbox" checked></label>
          <label>autoGainControl <input id="agc" type="checkbox" checked></label>
        </div>
      </div>
    </div>

    <!-- FFT -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:2px">
        <b>RTA ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (FFT, dB-A)</b>
        <span class="hint" id="labelRate">‚Äî</span>
      </div>
      <div class="badges">
        <span class="badge" id="fftPeakText">Peak: ‚Äî</span>
        <span class="badge" id="fftHoldText" style="display:none;">Hold: ‚Äî</span>
      </div>
      <div class="plot">
        <canvas id="fftCanvas" width="1200" height="320"></canvas>
        <div id="fftTip" class="tip" style="display:none">‚Äî</div>
      </div>
    </div>

    <!-- OCTAVE -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:2px">
        <b id="octTitle">RTA ‡πÅ‡∏ö‡∏ö 1/6 Octave (dB-A)</b>
        <span class="hint" id="labelOct">20 Hz ‚Äì 20 kHz</span>
      </div>
      <div class="badges">
        <span class="badge" id="octPeakText">Peak: ‚Äî</span>
        <span class="badge" id="octHoldText" style="display:none;">Hold: ‚Äî</span>
      </div>
      <div class="plot">
        <canvas id="octCanvas" width="1200" height="320"></canvas>
        <div id="octTip" class="tip" style="display:none">‚Äî</div>
      </div>
    </div>

    <!-- HEATMAP -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:2px">
        <b>Spectrogram / Heatmap (dB-A)</b>
        <button id="btnToggleHeatmap" class="ghost" aria-pressed="true">üî• Heatmap: ON</button>
      </div>
      <div class="plot">
        <canvas id="heatmapCanvas" width="1200" height="320"></canvas>
        <div id="heatmapTip" class="tip" style="display:none">‚Äî</div>
      </div>
    </div>

    <!-- LOUDNESS (dB-A) -->
    <div class="card kv">
      <div>
        <b>AVG (dB-A)</b>
        <span id="levelAvg">‚Äî</span>
      </div>
      <div class="meter-now">
        <b>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Real-time dB-A)</b>
        <span id="levelNow">‚Äî</span>
      </div>
      <div>
        <b>MAX (dB-A)</b>
        <span id="levelMax">‚Äî</span>
      </div>
    </div>

    <div class="card hint">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î: ‡πÑ‡∏°‡∏Ñ‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ DSP ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ü‡∏•‡∏ï ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô dB-A ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ ‚Äî ‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á</div>
  </div>

<script>
(() => {
  // ---- layout/grid ----
  const PAD = { L:40, R:10, T:10, B:32 }, LABEL_Y=10;
  const css = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();
  const GRID_H = css('--gridH'), GRID_V = css('--gridV'), FRAME = css('--frame'), LABEL = css('--label');
  const COL_FFT = css('--fft'), COL_HOLD = css('--hold'), COL_BAR = css('--bar');
  const LINE_PEAK = css('--peakline'), LINE_HOLD = css('--holdline');

  // ---- DOM ----
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnHold  = document.getElementById('btnHold');
  const btnClear = document.getElementById('btnClear');
  const btnToggleHeatmap = document.getElementById('btnToggleHeatmap');
  const fftSel = document.getElementById('fft');
  const smoothing = document.getElementById('smoothing');
  const avgChk = document.getElementById('avg');
  const octResSel = document.getElementById('octRes');
  const calInput = document.getElementById('cal');

  const fftCanvas = document.getElementById('fftCanvas');
  const octCanvas = document.getElementById('octCanvas');
  const heatmapCanvas = document.getElementById('heatmapCanvas');
  const ctxFFT = fftCanvas.getContext('2d');
  const ctxOct = octCanvas.getContext('2d');
  const ctxHeat = heatmapCanvas.getContext('2d');

  const fftTip = document.getElementById('fftTip');
  const octTip = document.getElementById('octTip');
  const heatTip = document.getElementById('heatmapTip');

  const labelRate = document.getElementById('labelRate');
  const labelOct  = document.getElementById('labelOct');
  const octTitle  = document.getElementById('octTitle');

  const fftPeakText = document.getElementById('fftPeakText');
  const fftHoldText = document.getElementById('fftHoldText');
  const octPeakText = document.getElementById('octPeakText');
  const octHoldText = document.getElementById('octHoldText');

  const levelAvgEl = document.getElementById('levelAvg');
  const levelNowEl = document.getElementById('levelNow');
  const levelMaxEl = document.getElementById('levelMax');

  const ec = document.getElementById('ec'), ns = document.getElementById('ns'), agc = document.getElementById('agc');

  // ---- audio state ----
  let audioCtx, analyser, micSrc, rafId;
  let dataArray, freqArray;
  let sampleRate = 48000;
  let running = false, holdEnabled=false;
  let avgBuffer=null, peakArray=null, peakOct=null;
  let octN = 6, bands=[];
  let guideFFT=null, guideOCT=null, guideHeat=null;

  // heatmap
  let heatmapOn = true, heatmapData=[], lastHeat=0;
  const HM_COLS = 300, HM_ROWS = 200, HM_DT = 33; // ~30 fps
  let hmBins=null;

  // meters (dB-A)
  let avgDBA=null, maxDBA=-Infinity;
  const AVG_ALPHA = 0.05;

  // ---- math helpers ----
  const clamp01 = v => Math.min(1, Math.max(0, v));
  const fmin=20, fmax = () => Math.min(sampleRate/2, 20000);

  function aWeighting(f){ // dB
    const f2=f*f;
    const ra=(12200**2 * f2**2) / ((f2+20.6**2)*(f2+12200**2)*Math.sqrt((f2+107.7**2)*(f2+737.9**2)));
    return 20*Math.log10(ra)+2.0;
  }
  const aGain = f => Math.pow(10, aWeighting(f)/20); // linear gain

  function mapLogX(f,w){
    const fm=fmax();
    const t=(Math.log10(Math.max(f,fmin))-Math.log10(fmin))/(Math.log10(fm)-Math.log10(fmin));
    return PAD.L + t * (w-PAD.L-PAD.R);
  }
  function xToFreq(x,w){
    const fm=fmax(), plotW=w-PAD.L-PAD.R;
    const t=clamp01((x-PAD.L)/plotW);
    const lf=Math.log10(fmin)+t*(Math.log10(fm)-Math.log10(fmin));
    return Math.pow(10,lf);
  }
  function mapDBtoY(db,w,h){ const plotH=h-PAD.T-PAD.B; const t=clamp01((db+100)/100); return PAD.T + (1-t)*plotH; }

  function drawBG(ctx){
    const {width:w,height:h}=ctx.canvas; const plotH=h-PAD.T-PAD.B;
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle=GRID_H; for(let i=0;i<6;i++){ const y=PAD.T+(i/5)*plotH; ctx.beginPath(); ctx.moveTo(PAD.L,y); ctx.lineTo(w-PAD.R,y); ctx.stroke(); }
    ctx.strokeStyle=GRID_V; const ticks=[20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000];
    ticks.forEach(t=>{ const x=mapLogX(t,w); ctx.beginPath(); ctx.moveTo(x,PAD.T); ctx.lineTo(x,PAD.T+plotH); ctx.stroke(); });
    ctx.strokeStyle=FRAME; ctx.strokeRect(PAD.L,PAD.T,w-PAD.L-PAD.R,plotH);
    ctx.fillStyle=LABEL; ctx.font='12px system-ui'; ctx.textBaseline='alphabetic';
    [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{ const x=mapLogX(t,w); ctx.fillText(t>=1000?(t/1000)+'k':t, x-8, h-LABEL_Y); });
    // Y labels (dB-A scale)
    ctx.textAlign='right'; ctx.textBaseline='middle';
    [-100,-80,-60,-40,-20,0].forEach((d,i)=>{ const y=PAD.T+(i/5)*plotH; ctx.fillText(d, PAD.L-5, y); });
  }
  function drawPeakLine(ctx,x,h,color, dashed=false){
    ctx.save(); ctx.strokeStyle=color; if(dashed) ctx.setLineDash([5,5]); ctx.beginPath(); ctx.moveTo(x,PAD.T); ctx.lineTo(x,h-PAD.B); ctx.stroke(); ctx.restore();
  }
  const fmtHz = f => f>=1000 ? ((f/1000>=10?(f/1000).toFixed(0):(f/1000).toFixed(1))+' kHz') : (Math.round(f)+' Hz');

  // ---- bands ----
  function genBands(n){
    const r=Math.pow(2,1/n), fm=fmax();
    const kmin=Math.ceil(Math.log(fmin/1000)/Math.log(r));
    const kmax=Math.floor(Math.log(fm/1000)/Math.log(r));
    const edge=Math.pow(2,1/(2*n));
    const arr=[];
    for(let k=kmin;k<=kmax;k++){
      const fc=1000*Math.pow(r,k), fl=fc/edge, fh=fc*edge;
      if(fh<fmin||fl>fm) continue;
      arr.push({fc, fl:Math.max(fl,fmin), fh:Math.min(fh,fm)});
    }
    labelOct.textContent = `${Math.round(arr[0].fc)} Hz ‚Äì ${Math.round(arr[arr.length-1].fc)} Hz`;
    octTitle.textContent = `RTA ‡πÅ‡∏ö‡∏ö 1/${n} Octave (dB-A)`;
    return arr;
  }

  // ---- heatmap bins ----
  function genHMBins(){
    const fm=fmax(), fpb=sampleRate/analyser.fftSize;
    const lmin=Math.log10(fmin), lmax=Math.log10(fm), bins=[];
    for(let i=0;i<HM_COLS;i++){
      const ls=lmin + i/HM_COLS*(lmax-lmin), le=lmin + (i+1)/HM_COLS*(lmax-lmin);
      const fs=Math.pow(10,ls), fe=Math.pow(10,le);
      const bs=Math.max(0,Math.floor(fs/fpb)), be=Math.min(analyser.frequencyBinCount-1, Math.ceil(fe/fpb));
      bins.push({bs,be,fs,fe});
    }
    return bins;
  }
  const heatColor = d => d<-60?css('--h1'):d<-40?css('--h2'):d<-20?css('--h3'):d<-5?css('--h4'):css('--h5');

  // ---- compute overall dB-A from spectrum ----
  function overallDBA(freq, fpb){
    // ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
    let e=0;
    for(let i=1;i<freq.length;i++){
      const f=i*fpb; if(f<20 || f>20000) continue;
      const mag = freq[i]/255;               // ~linear
      const gain = aGain(f);                 // A-weight gain (linear)
      const am = mag*gain;
      e += am*am;
    }
    const db = 10*Math.log10(e + 1e-12);
    return db + Number(calInput.value||0);
  }

  // ---- draw FFT ----
  function drawFFT(){
    const {width:w,height:h}=ctxFFT.canvas; drawBG(ctxFFT);
    if(!freqArray) return;
    const N=freqArray.length, fpb=sampleRate/(2*N);

    // smooth avg buffer if enabled
    if(avgChk.checked){
      if(!avgBuffer || avgBuffer.length!==N) avgBuffer=new Float32Array(N);
      const a=.5; for(let i=0;i<N;i++){ avgBuffer[i]=a*avgBuffer[i]+(1-a)*freqArray[i]; freqArray[i]=avgBuffer[i]; }
    }

    if(!peakArray || peakArray.length!==N) peakArray=new Uint8Array(N);
    if(holdEnabled) for(let i=0;i<N;i++) peakArray[i]=Math.max(peakArray[i], freqArray[i]);

    // find peak (by dB-A)
    let pBin=0, pVal=-1e9;
    for(let i=1;i<N;i++){
      const f=i*fpb; if(f<20||f>20000) continue;
      const dba = 20*Math.log10(freqArray[i]/255 + 1e-12) + aWeighting(f) + Number(calInput.value||0);
      if(dba>pVal){ pVal=dba; pBin=i; }
    }
    const xPeak = mapLogX(pBin*fpb, w);

    // current curve (convert each bin ‚Üí dB-A to map Y)
    ctxFFT.beginPath(); let started=false;
    for(let i=1;i<N;i++){
      const f=i*fpb; if(f<20||f>20000) continue;
      const dba = 20*Math.log10(freqArray[i]/255 + 1e-12) + aWeighting(f) + Number(calInput.value||0);
      const x=mapLogX(f,w), y=mapDBtoY(dba,w,h);
      if(!started){ ctxFFT.moveTo(x,y); started=true; } else ctxFFT.lineTo(x,y);
    }
    ctxFFT.strokeStyle=COL_FFT; ctxFFT.lineWidth=2; ctxFFT.stroke();

    // hold (convert hold‚ÜídB-A)
    ctxFFT.beginPath(); started=false;
    for(let i=1;i<N;i++){
      const f=i*fpb; if(f<20||f>20000) continue;
      const dba = 20*Math.log10((peakArray[i]||0)/255 + 1e-12) + aWeighting(f) + Number(calInput.value||0);
      const x=mapLogX(f,w), y=mapDBtoY(dba,w,h);
      if(!started){ ctxFFT.moveTo(x,y); started=true; } else ctxFFT.lineTo(x,y);
    }
    ctxFFT.save(); ctxFFT.globalAlpha=.35; ctxFFT.strokeStyle=COL_HOLD; ctxFFT.lineWidth=1.25; ctxFFT.stroke(); ctxFFT.restore();

    // peak lines
    drawPeakLine(ctxFFT, xPeak, h, LINE_PEAK, false);
    // hold peak line
    let hb=0,hv=-1e9;
    for(let i=1;i<N;i++){
      const f=i*fpb; if(f<20||f>20000) continue;
      const dba = 20*Math.log10((peakArray[i]||0)/255 + 1e-12) + aWeighting(f) + Number(calInput.value||0);
      if(dba>hv){ hv=dba; hb=i; }
    }
    if(hv>-1e9) drawPeakLine(ctxFFT, mapLogX(hb*fpb,w), h, LINE_HOLD, true);

    fftPeakText.textContent = `Peak: ${fmtHz(pBin*fpb)} ‚Ä¢ ${pVal.toFixed(1)} dB-A`;
    if(hv>-1e9){ fftHoldText.style.display=''; fftHoldText.textContent=`Hold: ${fmtHz(hb*fpb)} ‚Ä¢ ${hv.toFixed(1)} dB-A`; }
    else fftHoldText.style.display='none';

    if(guideFFT) drawPeakLine(ctxFFT, guideFFT.xPx, h, 'rgba(96,165,250,.7)', true);
  }

  // ---- draw Octave (bars in dB-A) ----
  function drawOct(){
    const {width:w,height:h}=ctxOct.canvas; drawBG(ctxOct);
    if(!freqArray || !bands.length) return;
    const N=freqArray.length, fpb=sampleRate/(2*N);

    // per-band level (linear ‚Üí A-weighted energy ‚Üí dB-A)
    const vals = bands.map(b=>{
      const s=Math.max(0,Math.floor(b.fl/fpb)), e=Math.min(N-1,Math.ceil(b.fh/fpb));
      let eSum=0;
      for(let i=s;i<=e;i++){
        const f=i*fpb; const mag=freqArray[i]/255; const g=aGain(f); const am=mag*g;
        eSum += am*am;
      }
      const dba = 10*Math.log10(eSum + 1e-12) + Number(calInput.value||0);
      return dba;
    });

    if(!peakOct || peakOct.length!==vals.length) peakOct=new Float32Array(vals.length);
    if(holdEnabled) for(let i=0;i<vals.length;i++) peakOct[i]=Math.max(peakOct[i], vals[i]);

    // bars
    ctxOct.fillStyle=COL_BAR;
    for(let i=0;i<vals.length;i++){
      const b=bands[i], xL=mapLogX(b.fl,w), xR=mapLogX(b.fh,w);
      const y=mapDBtoY(vals[i],w,h); const bottom=h-PAD.B;
      ctxOct.fillRect(xL+1, y, Math.max(2, xR-xL-2), Math.max(1,bottom-y));
    }

    // hold curve
    ctxOct.beginPath();
    for(let i=0;i<vals.length;i++){
      const cx=mapLogX(bands[i].fc,w), y=mapDBtoY(peakOct[i]||-100,w,h);
      if(i===0) ctxOct.moveTo(cx,y); else ctxOct.lineTo(cx,y);
    }
    ctxOct.save(); ctxOct.globalAlpha=.45; ctxOct.strokeStyle=LINE_HOLD; ctxOct.lineWidth=1.5; ctxOct.stroke(); ctxOct.restore();

    // peaks
    let idxNow=0; for(let i=1;i<vals.length;i++) if(vals[i]>vals[idxNow]) idxNow=i;
    drawPeakLine(ctxOct, mapLogX(bands[idxNow].fc,w), h, LINE_PEAK, false);

    let idxHold=-1, hold=-1e9; for(let i=0;i<peakOct.length;i++) if(peakOct[i]>hold){ hold=peakOct[i]; idxHold=i; }
    if(idxHold>=0) drawPeakLine(ctxOct, mapLogX(bands[idxHold].fc,w), h, LINE_HOLD, true);

    octPeakText.textContent = `Peak: ${fmtHz(bands[idxNow].fc)} ‚Ä¢ ${vals[idxNow].toFixed(1)} dB-A`;
    if(idxHold>=0){ octHoldText.style.display=''; octHoldText.textContent=`Hold: ${fmtHz(bands[idxHold].fc)} ‚Ä¢ ${hold.toFixed(1)} dB-A`; }
    else octHoldText.style.display='none';

    if(guideOCT) drawPeakLine(ctxOct, guideOCT.xPx, h, 'rgba(96,165,250,.7)', true);
  }

  // ---- heatmap (dB-A) ----
  function drawHeat(){
    const {width:w,height:h}=ctxHeat.canvas; const plotH=h-PAD.B;
    if(!freqArray || !hmBins) return;

    // build current row (dB-A per column)
    const row = hmBins.map(b=>{
      let e=0;
      for(let j=b.bs;j<=b.be;j++){
        const f = j*(sampleRate/analyser.fftSize);
        const a = freqArray[j]/255 * aGain(f);
        e += a*a;
      }
      const dba = 10*Math.log10(e + 1e-12) + Number(calInput.value||0);
      return {dba, fs:b.fs, fe:b.fe};
    });

    heatmapData.unshift(row); if(heatmapData.length>HM_ROWS) heatmapData.pop();

    // draw
    const yScale = plotH/HM_ROWS;
    ctxHeat.clearRect(0,0,w,h);
    for(let r=0;r<heatmapData.length;r++){
      const y=r*yScale; const fr=heatmapData[r];
      for(let c=0;c<fr.length;c++){
        const x1=mapLogX(fr[c].fs,w), x2=mapLogX(fr[c].fe,w);
        ctxHeat.fillStyle = heatColor(fr[c].dba);
        ctxHeat.fillRect(x1, y, Math.max(1,x2-x1), yScale);
      }
    }
    // x labels area
    ctxHeat.clearRect(0,plotH,w,PAD.B);
    ctxHeat.strokeStyle=GRID_V;
    [20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000]
      .forEach(t=>{ const x=mapLogX(t,w); ctxHeat.beginPath(); ctxHeat.moveTo(x,0); ctxHeat.lineTo(x,plotH); ctxHeat.stroke(); });
    ctxHeat.fillStyle=LABEL; ctxHeat.font='12px system-ui'; ctxHeat.textBaseline='alphabetic';
    [31.5,63,125,250,500,1000,2000,4000,8000,16000]
      .forEach(t=>{ const x=mapLogX(t,w); ctxHeat.fillText(t>=1000?(t/1000)+'k':t, x-8, h-LABEL_Y); });

    if(guideHeat) drawPeakLine(ctxHeat, guideHeat.xPx, h, 'rgba(96,165,250,.7)', true);
  }

  // ---- meters update (dB-A) ----
  function updateMeters(){
    const N=freqArray.length, fpb=sampleRate/(2*N);
    const dba = overallDBA(freqArray, fpb);           // realtime
    levelNowEl.textContent = dba.toFixed(1)+' dB-A';
    if(dba>maxDBA) maxDBA=dba; levelMaxEl.textContent = maxDBA.toFixed(1)+' dB-A';
    avgDBA = (avgDBA==null)? dba : (AVG_ALPHA*dba + (1-AVG_ALPHA)*avgDBA);
    levelAvgEl.textContent = avgDBA.toFixed(1)+' dB-A';
  }

  // ---- loop ----
  function loop(){
    if(!running) return;
    analyser.getByteTimeDomainData(dataArray);
    analyser.getByteFrequencyData(freqArray);

    drawFFT(); drawOct(); updateMeters();

    const now=performance.now();
    if(heatmapOn && now-lastHeat>=HM_DT){ drawHeat(); lastHeat=now; }
    rafId=requestAnimationFrame(loop);
  }

  // ---- start/stop ----
  async function start(){
    try{
      btnStart.disabled=true; btnStop.disabled=false;
      const constraints={ audio:{ echoCancellation: ec.checked? false:true, noiseSuppression: ns.checked? false:true, autoGainControl: agc.checked? false:true } };
      const stream=await navigator.mediaDevices.getUserMedia(constraints);
      audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
      if(audioCtx.state==='suspended') await audioCtx.resume();
      sampleRate=audioCtx.sampleRate; document.getElementById('labelRate').textContent=`${Math.round(sampleRate)} Hz`;

      analyser=audioCtx.createAnalyser();
      analyser.fftSize=parseInt(fftSel.value,10);
      analyser.smoothingTimeConstant=parseFloat(smoothing.value);

      micSrc=audioCtx.createMediaStreamSource(stream); micSrc.connect(analyser);

      dataArray=new Uint8Array(analyser.fftSize);
      freqArray=new Uint8Array(analyser.frequencyBinCount);
      peakArray=new Uint8Array(analyser.frequencyBinCount);

      bands=genBands(octN); peakOct=new Float32Array(bands.length);
      hmBins=genHMBins();

      avgDBA=null; maxDBA=-Infinity; heatmapData=[]; lastHeat=0;
      running=true; loop();
    }catch(err){
      alert('‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err.message||err));
      btnStart.disabled=false; btnStop.disabled=true;
    }
  }
  function stop(){
    running=false; if(rafId) cancelAnimationFrame(rafId);
    try{ micSrc&&micSrc.disconnect(); }catch{} try{ analyser&&analyser.disconnect(); }catch{}
    if(audioCtx) audioCtx.close(); btnStart.disabled=false; btnStop.disabled=true;
  }

  // ---- interactions ----
  function attachPressGuide(canvas, tipEl, which){
    let pressed=false;
    const getX=e=>{
      const r=canvas.getBoundingClientRect();
      const xCss=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
      return Math.max(PAD.L, Math.min(canvas.width-PAD.R, xCss*(canvas.width/r.width)));
    };
    const update=x=>{
      const f=xToFreq(x,canvas.width), plot=canvas.parentElement.getBoundingClientRect();
      tipEl.style.display='block'; tipEl.textContent=fmtHz(f);
      tipEl.style.left=(x/canvas.width)*plot.width+'px'; tipEl.style.top='8px';
      if(which==='fft') guideFFT={xPx:x}; else if(which==='oct') guideOCT={xPx:x}; else guideHeat={xPx:x};
    };
    const clear=()=>{
      tipEl.style.display='none';
      if(which==='fft') guideFFT=null; else if(which==='oct') guideOCT=null; else guideHeat=null;
    };
    const down=e=>{ pressed=true; e.preventDefault(); update(getX(e)); };
    const move=e=>{ if(!pressed) return; e.preventDefault(); update(getX(e)); };
    const up=()=>{ pressed=false; clear(); };
    canvas.addEventListener('touchstart',down,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false});
    canvas.addEventListener('touchend',up,{passive:true}); canvas.addEventListener('mousedown',down);
    window.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
    canvas.addEventListener('contextmenu',e=>e.preventDefault());
  }
  attachPressGuide(fftCanvas,fftTip,'fft');
  attachPressGuide(octCanvas,octTip,'oct');
  attachPressGuide(heatmapCanvas,heatTip,'heat');

  // ---- events ----
  btnStart.addEventListener('click', start);
  btnStop.addEventListener('click', stop);
  btnHold.addEventListener('click', ()=>{ holdEnabled=!holdEnabled; btnHold.setAttribute('aria-pressed',String(holdEnabled)); btnHold.textContent=holdEnabled?'üìå Hold Peak: ON':'üìå Hold Peak: OFF'; if(!holdEnabled){ peakArray&&peakArray.fill(0); peakOct&&peakOct.fill(-1e9); } });
  btnClear.addEventListener('click', ()=>{ peakArray&&peakArray.fill(0); peakOct&&peakOct.fill(-1e9); fftHoldText.style.display='none'; octHoldText.style.display='none'; avgDBA=null; maxDBA=-Infinity; levelAvgEl.textContent='‚Äî'; levelNowEl.textContent='‚Äî'; levelMaxEl.textContent='‚Äî'; });
  btnToggleHeatmap.addEventListener('click', ()=>{ heatmapOn=!heatmapOn; btnToggleHeatmap.setAttribute('aria-pressed',String(heatmapOn)); btnToggleHeatmap.textContent=heatmapOn?'üî• Heatmap: ON':'üî• Heatmap: OFF'; });

  fftSel.addEventListener('change', ()=>{ if(!analyser) return; analyser.fftSize=parseInt(fftSel.value,10); dataArray=new Uint8Array(analyser.fftSize); freqArray=new Uint8Array(analyser.frequencyBinCount); peakArray=new Uint8Array(analyser.frequencyBinCount); hmBins=genHMBins(); });
  smoothing.addEventListener('input', ()=>{ if(analyser) analyser.smoothingTimeConstant=parseFloat(smoothing.value); });
  octResSel.addEventListener('change', ()=>{ octN=parseInt(octResSel.value,10); bands=genBands(octN); peakOct=new Float32Array(bands.length); });
  calInput.addEventListener('input', ()=>{}); // ‡∏ú‡∏•‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏ô loop
})();
</script>
</body>
</html>
